name: Upload to CDN
inputs:
  - {name: model_pth, type: Model, description: "Trained model file (e.g., trained_model.pth)"}
  - {name: config_string, type: String, description: "Configuration string (e.g., JSON)"}
  - {name: bearer_token, type: string, description: "Bearer token for CDN authentication"}
  - {name: domain, type: String, description: "CDN domain base (e.g., https://api.example.com)"}
  - {name: get_cdn, type: String, description: "Public CDN base URL to prepend to returned relative cdnUrl"}
outputs:
  - {name: model_weights_cdn, type: String, description: "JSON containing the model CDN URL"}
  - {name: config_cdn_url, type: String, description: "JSON containing the config CDN URL"}
implementation:
  container:
    image: python:3.8
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os
        import uuid
        import tempfile

        parser = argparse.ArgumentParser(description="Upload model and config to a CDN.")
        parser.add_argument('--model_pth', type=str, required=True)
        parser.add_argument('--config_string', type=str, required=True)
        parser.add_argument('--model_weights_cdn', type=str, required=True)
        parser.add_argument('--config_cdn_url', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        args = parser.parse_args()

        def ensure_parent_dir(path):
            parent = os.path.dirname(path)
            if parent:
                os.makedirs(parent, exist_ok=True)

        def atomic_write_json(path, data):
            """
            Write JSON atomically: write to a temp file in same dir and rename.
            """
            ensure_parent_dir(path)
            dirp = os.path.dirname(path) or "/tmp"
            fd, tmp = tempfile.mkstemp(prefix="tmp_json_", dir=dirp)
            try:
                with os.fdopen(fd, "w") as f:
                    json.dump(data, f)
                os.replace(tmp, path)
            except Exception:
                try:
                    os.remove(tmp)
                except Exception:
                    pass
                raise

        # Read bearer token
        with open(args.bearer_token, 'r') as f:
            bearer_token = f.read().strip()

        upload_url = f"{args.domain}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"

        def upload_file_to_cdn(file_path, output_json_path, output_key):
            print(f"[DEBUG] Uploading {file_path} -> expecting output file {output_json_path} with key '{output_key}'")
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error"
            ]

            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    check=True
                )
                stdout = process.stdout.decode("utf-8")
                print("[DEBUG] Raw upload response:", stdout)

                try:
                    response_json = json.loads(stdout)
                except Exception as e:
                    print("[ERROR] Failed to parse JSON from upload response:", str(e))
                    raise

                relative_cdn_url = response_json.get("cdnUrl")
                if not relative_cdn_url:
                    raise ValueError("Missing 'cdnUrl' in CDN response")

                final_url = f"{args.get_cdn}{relative_cdn_url}"

                # Ensure parent dir exists and write JSON atomically
                atomic_write_json(output_json_path, {output_key: final_url})
                print(f"[INFO] Wrote {output_key} to {output_json_path}")

                return final_url

            except subprocess.CalledProcessError as e:
                print("Upload failed. curl return code:", e.returncode)
                try:
                    print("curl stdout:", e.stdout.decode("utf-8"))
                    print("curl stderr:", e.stderr.decode("utf-8"))
                except Exception:
                    pass
                raise
            except Exception as e:
                print("Upload_file_to_cdn error:", str(e))
                raise

        # Prepare and upload model
        model_tmp = f"/tmp/model_{uuid.uuid4()}.pth"
        try:
            with open(args.model_pth, "rb") as src, open(model_tmp, "wb") as dst:
                dst.write(src.read())
            model_url = upload_file_to_cdn(model_tmp, args.model_weights_cdn, "model_weights_cdn")
        finally:
            try:
                os.remove(model_tmp)
            except Exception:
                pass

        # Prepare and upload config
        config_tmp = f"/tmp/config_{uuid.uuid4()}.json"
        try:
            with open(config_tmp, "w") as f:
                f.write(args.config_string)
            config_url = upload_file_to_cdn(config_tmp, args.config_cdn_url, "config_cdn_url")
        finally:
            try:
                os.remove(config_tmp)
            except Exception:
                pass

        print("Model CDN URL:", model_url)
        print("Config CDN URL:", config_url)

    args:
      - --model_pth
      - {inputPath: model_pth}
      - --config_string
      - {inputValue: config_string}
      - --bearer_token
      - {inputPath: bearer_token}
      - --get_cdn
      - {inputValue: get_cdn}
      - --domain
      - {inputValue: domain}
      - --model_weights_cdn
      - {outputPath: model_weights_cdn}
      - --config_cdn_url
      - {outputPath: config_cdn_url}
