name: CDN Download PTH
description: Download trained_model.pth from a CDN URL and save it locally.
inputs:
  - {name: pth_url, type: String, description: "URL to fetch the trained_model.pth model file from"}
outputs:
  - {name: pth_file, type: Model, description: "Downloaded trained_model.pth model file"}
implementation:
  container:
    image: nikhilv215/nesy-factory:v22
    command:
      - python3
      - -u
      - -c
      - |
        import os, sys, requests

        # Prefer environment variables (PTH_URL, PTH_FILE), fallback to sys.argv
        pth_url = os.environ.get('PTH_URL')
        pth_out_dir = os.environ.get('PTH_FILE')

        # If not provided via env, try command-line args (first arg = pth_url, second = pth_file)
        if not pth_url and len(sys.argv) > 1:
            pth_url = sys.argv[1]
        if not pth_out_dir and len(sys.argv) > 2:
            pth_out_dir = sys.argv[2]

        if not pth_url:
            print("Error: PTH URL not provided (set PTH_URL or pass as first arg)")
            sys.exit(1)
        if not pth_out_dir:
            print("Error: Output directory not provided (set PTH_FILE or pass as second arg)")
            sys.exit(1)

        print("Downloading trained_model.pth from:", pth_url)
        try:
            resp = requests.get(pth_url, timeout=300)
            resp.raise_for_status()

            os.makedirs(pth_out_dir, exist_ok=True)
            pth_path = os.path.join(pth_out_dir, 'trained_model.pth')
            with open(pth_path, "wb") as f:
                f.write(resp.content)

            print("Saved PTH at:", pth_path)
            print("Size (bytes):", len(resp.content))

            # Verify
            if os.path.exists(pth_path) and os.path.getsize(pth_path) > 0:
                print("trained_model.pth downloaded and verified")
            else:
                raise Exception("trained_model.pth download verification failed")

        except requests.exceptions.Timeout:
            print("Error: Request timed out while downloading the PTH")
            sys.exit(1)
        except requests.exceptions.RequestException as e:
            print("Error: Network error during download:", str(e))
            sys.exit(1)
        except Exception as e:
            print("Error: Failed to download PTH:", str(e))
            import traceback
            traceback.print_exc()
            sys.exit(1)
    args:
      - --pth_url
      - {inputValue: pth_url}
      - --pth_file
      - {outputPath: pth_file}
