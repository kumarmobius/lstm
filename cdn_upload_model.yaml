name: Upload to CDN V1

inputs:
  - {name: model_onnx, type: Model}
  - {name: config_string, type: String}
  - {name: bearer_token, type: string}
  - {name: domain, type: String}
  - {name: get_cdn, type: String}
  - {name: name, type: String}

outputs:
  - {name: model_onnx_cdn, type: String, description: "JSON containing the ONNX CDN URL (and optional name)"}

implementation:
  container:
    image: python:3.8
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os
        import uuid
        import tempfile
        import traceback
        from glob import iglob

        parser = argparse.ArgumentParser(description="Upload ONNX model to CDN (robust to directory inputs).")
        parser.add_argument('--model_onnx', type=str, required=True)
        parser.add_argument('--config_string', type=str, required=True)
        parser.add_argument('--model_onnx_cdn', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        parser.add_argument('--name', type=str, default="", required=False)
        args = parser.parse_args()

        def ensure_parent_dir(path):
            parent = os.path.dirname(path)
            if parent:
                os.makedirs(parent, exist_ok=True)

        def atomic_write_json(path, data):
            ensure_parent_dir(path)
            dirp = os.path.dirname(path) or "/tmp"
            fd, tmp = tempfile.mkstemp(prefix="tmp_json_", dir=dirp)
            try:
                with os.fdopen(fd, "w") as f:
                    json.dump(data, f)
                os.replace(tmp, path)
            except Exception:
                try:
                    os.remove(tmp)
                except Exception:
                    pass
                raise

        def find_onnx_in_path(path):
            # If path is file and endswith .onnx -> return it
            if os.path.isfile(path):
                if path.lower().endswith('.onnx'):
                    return path
                # maybe the uploaded file had a different name; still return it as candidate
                return path
            # If directory, search recursively for .onnx files
            if os.path.isdir(path):
                # prefer .onnx files
                candidates = []
                for root, dirs, files in os.walk(path):
                    for fn in files:
                        if fn.lower().endswith('.onnx'):
                            candidates.append(os.path.join(root, fn))
                if candidates:
                    # choose the largest .onnx (heuristic)
                    candidates.sort(key=lambda p: os.path.getsize(p), reverse=True)
                    return candidates[0]
                # fallback: if directory contains exactly one file, return it
                flat_files = []
                for root, dirs, files in os.walk(path):
                    for fn in files:
                        flat_files.append(os.path.join(root, fn))
                if len(flat_files) == 1:
                    return flat_files[0]
                # no candidate found
                return None
            # path doesn't exist
            return None

        # Read bearer token
        try:
            with open(args.bearer_token, 'r') as f:
                bearer_token = f.read().strip()
        except Exception as e:
            err = {"error": f"Failed to read bearer token: {e}"}
            atomic_write_json(args.model_onnx_cdn, err)
            raise

        upload_url = f"{args.domain.rstrip('/')}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"

        def build_output_dict(key, url):
            out = {key: url}
            if args.name and args.name.strip():
                out['name'] = args.name.strip()
            return out

        def upload_to_cdn(file_path):
            print(f"[DEBUG] Uploading file: {file_path}")
            curl_cmd = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error",
            ]
            proc = subprocess.run(curl_cmd, capture_output=True, check=True)
            stdout = proc.stdout.decode("utf-8")
            print("[DEBUG] Raw CDN response:", stdout)
            try:
                resp = json.loads(stdout)
            except Exception as e:
                raise RuntimeError(f"Failed to parse CDN response as JSON: {e}. Raw: {stdout}")
            rel = resp.get("cdnUrl")
            if not rel:
                raise RuntimeError(f"CDN response missing 'cdnUrl': {resp}")
            final = args.get_cdn.rstrip('/') + rel
            return final

        # main flow
        try:
            resolved = find_onnx_in_path(args.model_onnx)
            if not resolved:
                raise FileNotFoundError(f"Could not find ONNX file in provided path: {args.model_onnx}")

            # copy to a temp file with .onnx suffix to be safe
            tmp_onnx = f"/tmp/model_{uuid.uuid4()}.onnx"
            with open(resolved, "rb") as src, open(tmp_onnx, "wb") as dst:
                dst.write(src.read())

            try:
                final_url = upload_to_cdn(tmp_onnx)
                out_obj = build_output_dict("model_onnx_cdn", final_url)
                atomic_write_json(args.model_onnx_cdn, out_obj)
                print("ONNX CDN URL:", final_url)
            finally:
                try: os.remove(tmp_onnx)
                except Exception: pass

        except Exception as e:
            tb = traceback.format_exc()
            print("[ERROR]", str(e))
            print(tb)
            err_obj = {"error": str(e), "traceback": tb}
            try:
                atomic_write_json(args.model_onnx_cdn, err_obj)
            except Exception as e2:
                print("[FATAL] Failed to write error JSON to output path:", e2)
            # re-raise so pipeline logs show the error status too
            raise

    args:
      - --model_onnx
      - {inputPath: model_onnx}
      - --config_string
      - {inputValue: config_string}
      - --bearer_token
      - {inputPath: bearer_token}
      - --get_cdn
      - {inputValue: get_cdn}
      - --domain
      - {inputValue: domain}
      - --name
      - {inputValue: name}
      - --model_onnx_cdn
      - {outputPath: model_onnx_cdn}
